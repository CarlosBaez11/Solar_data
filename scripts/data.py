import requests
import pandas as pd
import urllib.parse
import time

API_KEY = "{{4ahbKpwQ9FFvjOFnsrMNL2uhr333d3MggmyuOIf}}"
EMAIL = "ieduardo.baez@udea.edu.co"
BASE_URL = "https://developer.nrel.gov/api/nsrdb/v2/solar/psm3-2-2-download.json?"
POINTS = [
'2016644,2016645,2016646,2016647,2016648,2016649,2016650,2016651,2016652,2016653,2016654,2016655,2016656,2016657,2016658,2016659,2016660,2016661,2016662,2016663,2016664,2016665,2016666,2016667,2016668,2016669,2016670,2016671,2016672,2016673,2016674,2016675,2016676,2016677,2016678,2016679,2016680,2016681,2016682,2016683,2016684,2016685,2016686,2016687,2016688,2016689,2016690,2016691,2016692,2016693,2016694,2016695,2016696,2016697,2016698,2016699,2016700,2016701,2016702,2016703,2016704,2016705,2016706,2016707,2016708,2016709,2016710,2016711,2016712,2016713,2016714,2016715,2016716,2016717,2016718,2016719,2016720,2016721,2016722,2016723,2016724,2016725,2016726,2016727,2016728,2016729,2016730,2016731,2016732,2016733,2016734,2016735,2016736,2016737,2016738,2016739,2016740,2016741,2016742,2016743,2016744,2016745,2016746,2016747,2016748,2016749,2016750,2016751,2016752,2016753,2016754,2016755,2016756,2016757,2016758,2016759,2016760,2016761,2016762,2016763,2016764,2016765,2016766,2016767,2016768,2016769,2016770,2016771,2016772,2016773,2016774,2016775,2016776,2016777,2016778,2016779,2016780,2016781,2016782,2016783,2016784,2016785,2016786,2016787,2016788,2016789,2016790,2016791,2016792,2016793,2016794,2016795,2016796,2016797,2016798,2016799,2016800,2016801,2016802,2016803,2016804,2016805,2016806,2016807,2016808,2016809,2016810,2016811,2016812,2016813,2016814,2016815,2016816,2016817,2016818,2016819,2016820,2016821,2016822,2016823,2016824,2016825,2016826,2016827,2016828,2016829,2016830,2016831,2016832,2016833,2016834,2016835,2016836,2016837,2016838,2016839,2016840,2016841,2016842,2016843',
'2016844,2016845,2016846,2016847,2016848,2016849,2016850,2016851,2016852,2016853,2016854,2016855,2016856,2016857,2016858,2016859,2016860,2016861,2016862,2016863,2016864,2016865,2016866,2016867,2016868,2016869,2016870,2016871,2016872,2016873,2016874,2016875,2016876,2016877,2016878,2016879,2016880,2016881,2016882,2016883,2016884,2016885,2016886,2016887,2016888,2016889,2016890,2016891,2016892,2016893,2016894,2016895,2016896,2016897,2016898,2016899,2016900,2016901,2016902,2016903,2016904,2016905,2016906,2016907,2016908,2016909,2016910,2016911,2016912,2016913,2016914,2016915,2016916,2016917,2016918,2016919,2016920,2016921,2016922,2016923,2016924,2016925,2016926,2016927,2016928,2016929,2016930,2016931,2016932,2016933,2016934,2016935,2016936,2016937,2016938,2016939,2016940,2016941,2016942,2016943,2016944,2016945,2016946,2016947,2016948,2016949,2016950,2016951,2016952,2016953,2016954,2016955,2016956,2016957,2016958,2016959,2016960,2016961,2016962,2016963,2016964,2016965,2016966,2016967,2016968,2016969,2016970,2016971,2016972,2016973,2016974,2016975,2016976,2016977,2016978,2016979,2016980,2016981,2016982,2016983,2016984,2016985,2016986,2016987,2016988,2016989,2016990,2016991,2016992,2016993,2016994,2016995,2016996,2016997,2016998,2016999,2017000,2017001,2017002,2017003,2017004,2017005,2017006,2017007,2017008,2017009,2017010,2017011,2017012,2017013,2017014,2017015,2017016,2017017,2017018,2017019,2017020,2017021,2017022,2017023,2017024,2017025,2017026,2017027,2017028,2017029,2017030,2017031,2017032,2017033,2017034,2017035,2017036,2017037,2017038,2017039,2017040,2017041,2017042,2017043',
'2017044,2017045,2017046,2017047,2017048,2017049,2017050,2017051,2017052,2017053,2017054,2017055,2017056,2017057,2017058,2017059,2017060,2017061,2017062,2017063,2017064,2017065,2017066,2017067,2017068,2017069,2017070,2017071,2017072,2017073,2017074,2017075,2017076,2017077,2017078,2017079,2017080,2017081,2017082,2017083,2017084,2017085,2017086,2017087,2017088,2017089,2017090,2017091,2017092,2017093,2017094,2017095,2017096,2017097,2017098,2017099,2017100,2017101,2017102,2017103,2017104,2017105,2017106,2017107,2017108,2017109,2017110,2017111,2017112,2017113,2017114,2017115,2017116,2017117,2017118,2017119,2017120,2017121,2017122,2017123,2017124,2017125,2017126,2017127,2017128,2017129,2017130,2017131,2017132,2017133,2017134,2017135,2017136,2017137,2017138,2017139,2017140,2017141,2017142,2017143,2017144,2017145,2017146,2017147,2017148,2017149,2017150,2017151,2017152,2017153,2017154,2017155,2017156,2017157,2017158,2017159,2017160,2017161,2017162,2017163,2017164,2017165,2017166,2017167,2017168,2017169,2017170,2017171,2017172,2017173,2017174,2017175,2017176,2017177,2017178,2017179,2017180,2017181,2017182,2017183,2017184,2017185,2017186,2017187,2017188,2017189,2017190,2017191,2017192,2017193,2017194,2017195,2017196,2017197,2017198,2017199,2017200,2017201,2017202,2017203,2017204,2017205,2017206,2017207,2017208,2017209,2017210,2017211,2017212,2017213,2017214,2017215,2017216,2017217,2017218,2017219,2017220,2017221,2017222,2017223,2017224,2017225,2017226,2017227,2017228,2017229,2017230,2017231,2017232,2017233,2017234,2017235,2017236,2017237,2017238,2017239,2017240,2017241,2017242,2017243',
'2017244,2017245,2017246,2017247,2017248,2017249,2017250,2017251,2017252,2017253,2017254,2017255,2017256,2017257,2017258,2017259,2017260,2017261,2017262,2017263,2017264,2017265,2017266,2017267,2017268,2017269,2017270,2017271,2017272,2017273,2017274,2017275,2017276,2017277,2017278,2017279,2017280,2017281,2017282,2017283,2017284,2017285,2017286,2017287,2017288,2017289,2017290,2017291,2017292,2017293,2017294,2017295,2017296,2017297,2017298,2017299,2017300,2017301,2017302,2017303,2017304,2017305,2017306,2017307,2017308,2017309,2017310,2017311,2017312,2017313,2017314,2017315,2017316,2017317,2017318,2017319,2017320,2017321,2017322,2017323,2017324,2017325,2017326,2017327,2017328,2017329,2017330,2017331,2017332,2017333,2017334,2017335,2017336,2017337,2017338,2017339,2017340,2017341,2017342,2017343,2017344,2017345,2017346,2017347,2017348,2017349,2017350,2017351,2017352,2017353,2017354,2017355,2017356,2017357,2017358,2017359,2017360,2017361,2017362,2017363,2017364,2017365,2017366,2017367,2017368,2017369,2017370,2017371,2017372,2017373,2017374,2017375,2017376,2017377,2017378,2017379,2017380,2017381,2017382,2017383,2017384,2017385,2017386,2017387,2017388,2017389,2017390,2017391,2017392,2017393,2017394,2017395,2017396,2017397,2017398,2017399,2017400,2017401,2017402,2017403,2017404,2017405,2017406,2017407,2017408,2017409,2017410,2017411,2017412,2017413,2017414,2017415,2017416,2017417,2017418,2017419,2017420,2017421,2017422,2017423,2017424,2017425,2017426,2017427,2017428,2017429,2017430,2017431,2017432,2017433,2017434,2017435,2017436,2017437,2017438,2017439,2017440,2017441,2017442,2017443',
'2017444,2017445,2017446,2017447,2017448,2017449,2017450,2017451,2017452,2017453,2017454,2017455,2017456,2017457,2017458,2017459,2017460,2017461,2017462,2017463,2017464,2017465,2017466,2017467,2017468,2017469,2017470,2017471,2017472,2017473,2017474,2017475,2017476,2017477,2017478,2017479,2017480,2017481,2017482,2017483,2017484,2017485,2017486,2017487,2017488,2017489,2017490,2017491,2017492,2017493,2017494,2017495,2017496,2017497,2017498,2017499,2017500,2017501,2017502,2017503,2017504,2017505,2017506,2017507,2017508,2017509,2017510,2017511,2017512,2017513,2017514,2017515,2017516,2017517,2017518,2017519,2017520,2017521,2017522,2017523,2017524,2017525,2017526,2017527,2017528,2017529,2017530,2017531,2017532,2017533,2017534,2017535,2017536,2017537,2017538,2017539,2017540,2017541,2017542,2017543,2017544,2017545,2017546,2017547,2017548,2017549,2017550,2017551,2017552,2017553,2017554,2017555,2017556,2017557,2017558,2017559,2017560,2017561,2017562,2017563,2017564,2017565,2017566,2017567,2017568,2017569,2017570,2017571,2017572,2017573,2017574,2017575,2017576,2017577,2017578,2017579,2017580,2017581,2017582,2017583,2017584,2017585,2017586,2017587,2017588,2017589,2017590,2017591,2017592,2017593,2017594,2017595,2017596,2017597,2017598,2017599,2017600,2017601,2017602,2017603,2017604,2017605,2017606,2017607,2017608,2017609,2017610,2017611,2017612,2017613,2017614,2017615,2017616,2017617,2017618,2017619,2017620,2017621,2017622,2017623,2017624,2017625,2017626,2017627,2017628,2017629,2017630,2017631,2017632,2017633,2017634,2017635,2017636,2017637,2017638,2017639,2017640,2017641,2017642,2017643',
'2017644,2017645,2017646,2017647,2017648,2017649,2017650,2017651,2017652,2017653,2017654,2017655,2017656,2017657,2017658,2017659,2017660,2017661,2017662,2017663,2017664,2017665,2017666,2017667,2017668,2017669,2017670,2017671,2017672,2017673,2017674,2017675,2017676,2017677,2017678,2017679,2017680,2017681,2017682,2017683,2017684,2017685,2017686,2017687,2017688,2017689,2017690,2017691,2017692,2017693,2017694,2017695,2017696,2017697,2017698,2017699,2017700,2017701,2017702,2017703,2017704,2017705,2017706,2017707,2017708,2017709,2017710,2017711,2017712,2017713,2017714,2017715,2017716,2017717,2017718,2017719,2017720,2017721,2017722,2017723,2017724,2017725,2017726,2017727,2017728,2017729,2017730,2017731,2017732,2017733,2017734,2017735,2017736,2017737,2017738,2017739,2017740,2017741,2017742,2017743,2017744,2017745,2017746,2017747,2017748,2017749,2017750,2017751,2017752,2017753,2017754,2017755,2017756,2017757,2017758,2017759,2017760,2017761,2017762,2017763,2017764,2017765,2017766,2017767,2017768,2017769,2017770,2017771,2017772,2017773,2017774,2017775,2017776,2017777,2017778,2017779,2017780,2017781,2017782,2017783,2017784,2017785,2017786,2017787,2017788,2017789,2017790,2017791,2017792,2017793,2017794,2017795,2017796,2017797,2017798,2017799,2017800,2017801,2017802,2017803,2017804,2017805,2017806,2017807,2017808,2017809,2017810,2017811,2017812,2017813,2017814,2017815,2017816,2017817,2017818,2017819,2017820,2017821,2017822,2017823,2017824,2017825,2017826,2017827,2017828,2017829,2017830,2017831,2017832,2017833,2017834,2017835,2017836,2017837,2017838,2017839,2017840,2017841,2017842,2017843',
'2017844,2017845,2017846,2017847,2017848,2017849,2017850,2017851,2017852,2017853,2017854,2017855,2017856,2017857,2017858,2017859,2017860,2017861,2017862,2017863,2017864,2017865,2017866,2017867,2017868,2017869,2017870,2017871,2017872,2017873,2017874,2017875,2017876,2017877,2017878,2017879,2017880,2017881,2017882,2017883,2017884,2017885,2017886,2017887,2017888,2017889,2017890,2017891,2017892,2017893,2017894,2017895,2017896,2017897,2017898,2017899,2017900,2017901,2017902,2017903,2017904,2017905,2017906,2017907,2017908,2017909,2017910,2017911,2017912,2017913,2017914,2017915,2017916,2017917,2017918,2017919,2017920,2017921,2017922,2017923,2017924,2017925,2017926,2017927,2017928,2017929,2017930,2017931,2017932,2017933,2017934,2017935,2017936,2017937,2017938,2017939,2017940,2017941,2017942,2017943,2017944,2017945,2017946,2017947,2017948,2017949,2017950,2017951,2017952,2017953,2017954,2017955,2017956,2017957,2017958,2017959,2017960,2017961,2017962,2017963,2017964,2017965,2017966,2017967,2017968,2017969,2017970,2017971,2017972,2017973,2017974,2017975,2017976,2017977,2017978,2017979,2017980,2017981,2017982,2017983,2017984,2017985,2017986,2017987,2017988,2017989,2017990,2017991,2017992,2017993,2017994,2017995,2017996,2017997,2017998,2017999,2018000,2018001,2018002,2018003,2018004,2018005,2018006,2018007,2018008,2018009,2018010,2018011,2018012,2018013,2018014,2018015,2018016,2018017,2018018,2018019,2018020,2018021,2018022,2018023,2018024,2018025,2018026,2018027,2018028,2018029,2018030,2018031,2018032,2018033,2018034,2018035,2018036,2018037,2018038,2018039,2018040,2018041,2018042,2018043',
'2018044,2018045,2018046,2018047,2018048,2018049,2018050,2018051,2018052,2018053,2018054,2018055,2018056,2018057,2018058,2018059,2018060,2018061,2018062,2018063,2018064,2018065,2018066,2018067,2018068,2018069,2018070,2018071,2018072,2018073,2018074,2018075,2018076,2018077,2018078,2018079,2018080,2018081,2018082,2018083,2018084,2018085,2018086,2018087,2018088,2018089,2018090,2018091,2018092,2018093,2018094,2018095,2018096,2018097,2018098,2018099,2018100,2018101,2018102,2018103,2018104,2018105,2018106,2018107,2018108,2018109,2018110,2018111,2018112,2018113,2018114,2018115,2018116,2018117,2018118,2018119,2018120,2018121,2018122,2018123,2018124,2018125,2018126,2018127,2018128,2018129,2018130,2018131,2018132,2018133,2018134,2018135,2018136,2018137,2018138,2018139,2018140,2018141,2018142,2018143,2018144,2018145,2018146,2018147,2018148,2018149,2018150,2018151,2018152,2018153,2018154,2018155,2018156,2018157,2018158,2018159,2018160,2018161,2018162,2018163,2018164,2018165,2018166,2018167,2018168,2018169,2018170,2018171,2018172,2018173,2018174,2018175,2018176,2018177,2018178,2018179,2018180,2018181,2018182,2018183,2018184,2018185,2018186,2018187,2018188,2018189,2018190,2018191,2018192,2018193,2018194,2018195,2018196,2018197,2018198,2018199,2018200,2018201,2018202,2018203,2018204,2018205,2018206,2018207,2018208,2018209,2018210,2018211,2018212,2018213,2018214,2018215,2018216,2018217,2018218,2018219,2018220,2018221,2018222,2018223,2018224,2018225,2018226,2018227,2018228,2018229,2018230,2018231,2018232,2018233,2018234,2018235,2018236,2018237,2018238,2018239,2018240,2018241,2018242,2018243',
'2018244,2018245,2018246,2018247,2018248,2018249,2018250,2018251,2018252,2018253,2018254,2018255,2018256,2018257,2018258,2018259,2018260,2018261,2018262,2018263,2018264,2018265,2018266'
]

def main():
    input_data = {
        'attributes': 'air_temperature,ghi,relative_humidity,cloud_type,clearsky_dhi,clearsky_dni,dew_point,solar_zenith_angle,total_precipitable_water,wind_speed,surface_pressure',
        'interval': '60',
        
        'api_key': API_KEY,
        'email': EMAIL,
    }
    for name in ['2020']:
        print(f"Processing name: {name}")
        for id, location_ids in enumerate(POINTS):
            input_data['names'] = [name]
            input_data['location_ids'] = location_ids
            print(f'Making request for point group {id + 1} of {len(POINTS)}...')

            if '.csv' in BASE_URL:
                url = BASE_URL + urllib.parse.urlencode(data, True)
                # Note: CSV format is only supported for single point requests
                # Suggest that you might append to a larger data frame
                data = pd.read_csv(url)
                print(f'Response data (you should replace this print statement with your processing): {data}')
                # You can use the following code to write it to a file
                # data.to_csv('SingleBigDataPoint.csv')
            else:
                headers = {
                  'x-api-key': API_KEY
                }
                data = get_response_json_and_handle_errors(requests.post(BASE_URL, input_data, headers=headers))
                download_url = data['outputs']['downloadUrl']
                # You can do with what you will the download url
                print(data['outputs']['message'])
                print(f"Data can be downloaded from this url when ready: {download_url}")

                # Delay for 1 second to prevent rate limiting
                time.sleep(1)
            print(f'Processed')


def get_response_json_and_handle_errors(response: requests.Response) -> dict:
    """Takes the given response and handles any errors, along with providing
    the resulting json

    Parameters
    ----------
    response : requests.Response
        The response object

    Returns
    -------
    dict
        The resulting json
    """
    if response.status_code != 200:
        print(f"An error has occurred with the server or the request. The request response code/status: {response.status_code} {response.reason}")
        print(f"The response body: {response.text}")
        exit(1)

    try:
        response_json = response.json()
    except:
        print(f"The response couldn't be parsed as JSON, likely an issue with the server, here is the text: {response.text}")
        exit(1)

    if len(response_json['errors']) > 0:
        errors = '\n'.join(response_json['errors'])
        print(f"The request errored out, here are the errors: {errors}")
        exit(1)
    return response_json

if __name__ == "__main__":
    main()